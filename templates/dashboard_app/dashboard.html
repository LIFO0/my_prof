{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Метрика — панель администратора</title>
    <link rel="stylesheet" href="{% static 'dashboard_app/styles.css' %}">
    <script defer src="{% static 'dashboard_app/dashboard.js' %}"></script>
</head>
<body>
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message message-{{ message.tags|default:'info' }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <header class="top-header">
        <a href="{% url 'dashboard' %}" class="top-header-brand">
            <img src="{% static 'dashboard_app/img/logo.png' %}" alt="Логотип Метрика" class="brand-logo">
            <div class="brand-text">
                <span class="brand-name">Метрика</span>
                <span class="brand-tagline">аналитическая платформа</span>
            </div>
        </a>
        <div class="top-header-search">
            <div class="search-container">
                <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#9a9a9a"/>
                </svg>
                <input type="search" id="global-search" class="search-input" placeholder="Поиск по компаниям, ИНН, ОКВЭД..." value="{{ filters.search|default_if_none:'' }}">
            </div>
        </div>
        <div class="top-header-account">
            <img src="{% static 'dashboard_app/img/account.png' %}" alt="Учетная запись" class="account-avatar">
            <div class="account-details">
                <span class="account-name">{{ user.get_full_name|default:user.username }}</span>
                <span class="account-role">({{ is_director|yesno:"директор,сотрудник" }})</span>
            </div>
            <a class="logout-button" href="{% url 'logout' %}">Выход</a>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h1 class="sidebar-title">Фильтры</h1>
            <p class="sidebar-subtitle">Комбинируйте параметры и получайте точную выборку данных.</p>
            <form id="filters-form" method="get">
                <div class="filter-group">
                    <label class="filter-label" for="filter-search">Поиск по названию или ФИО</label>
                    <input id="filter-search" type="text" name="search" class="filter-input" value="{{ filters.search|default_if_none:'' }}" placeholder="Например: БИТРИКС">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Основной ОКВЭД</label>
                    <select class="filter-select" name="okved">
                        <option value="">Все направления</option>
                        {% for okved in filter_options.okveds %}
                        <option value="{{ okved }}" {% if filters.okved == okved %}selected{% endif %}>{{ okved }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Применяет УСН</label>
                    <select class="filter-select" name="uses_usn">
                        <option value="">Не важно</option>
                        <option value="yes" {% if filters.uses_usn is True %}selected{% endif %}>Да</option>
                        <option value="no" {% if filters.uses_usn is False %}selected{% endif %}>Нет</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Аккредитация</label>
                    <select class="filter-select" name="is_accredited">
                        <option value="">Не важно</option>
                        <option value="yes" {% if filters.is_accredited is True %}selected{% endif %}>Аккредитована</option>
                        <option value="no" {% if filters.is_accredited is False %}selected{% endif %}>Не аккредитована</option>
                    </select>
                </div>

                <div class="filter-row">
                    <div class="filter-group-half">
                        <label class="filter-label">Мин. выручка (₽)</label>
                        <input type="number" class="filter-input-small" name="min_revenue" min="{{ bounds.revenue.0 }}" max="{{ bounds.revenue.1 }}" step="100000" value="{{ filters.min_revenue|default_if_none:'' }}" placeholder="{{ bounds.revenue.0|default:0 }}">
                    </div>
                    <div class="filter-group-half">
                        <label class="filter-label">Макс. выручка (₽)</label>
                        <input type="number" class="filter-input-small" name="max_revenue" min="{{ bounds.revenue.0 }}" max="{{ bounds.revenue.1 }}" step="100000" value="{{ filters.max_revenue|default_if_none:'' }}" placeholder="{{ bounds.revenue.1|default:0 }}">
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Мин. налоги (₽)</label>
                    <input type="number" class="filter-input" name="min_taxes" min="{{ bounds.taxes.0 }}" max="{{ bounds.taxes.1 }}" step="50000" value="{{ filters.min_taxes|default_if_none:'' }}">
                </div>

                <div class="filter-group">
                    <label class="filter-label">Мин. численность сотрудников</label>
                    <input type="number" class="filter-input" name="min_staff" min="{{ bounds.staff.0 }}" max="{{ bounds.staff.1 }}" value="{{ filters.min_staff|default_if_none:'' }}">
                </div>

                <div class="filter-row">
                    <div class="filter-group-half">
                        <label class="filter-label filter-label-wrap">Год уплаты налогов</label>
                        <select class="filter-select-small" name="tax_year">
                            <option value="">Любой</option>
                            {% for year in filter_options.tax_years %}
                            <option value="{{ year }}" {% if filters.tax_year == year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group-half">
                        <label class="filter-label filter-label-wrap">Год численности</label>
                        <select class="filter-select-small" name="staff_year">
                            <option value="">Любой</option>
                            {% for year in filter_options.staff_years %}
                            <option value="{{ year }}" {% if filters.staff_year == year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn-apply">Применить фильтры</button>
                    <a class="btn-reset" href="{% url 'dashboard' %}">Сбросить</a>
                </div>
            </form>

            <p class="quick-scenarios-title">БЫСТРЫЕ СЦЕНАРИИ</p>
            <div class="quick-scenarios">
                <button type="button" class="filter-select" data-filter-preset="top-revenue">Лидеры по выручке</button>
                <button type="button" class="filter-select" data-filter-preset="hi-staff">100+ сотрудников</button>
                <button type="button" class="filter-select" data-filter-preset="usn-only">Только УСН</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1 class="page-title">Главная страница</h1>
                <p class="page-subtitle">Удобство и функциональность в одном месте.</p>
            </header>

            <section class="stats-grid">
                <article class="stat-card stat-card-primary">
                    <div class="stat-icon">
                        <img src="{% static 'dashboard_app/img/icon_1.png' %}" alt="Количество компаний">
                    </div>
                    <h3 class="stat-title">Количество Компаний</h3>
                    <p class="stat-value">{{ dataset_stats.count|default:0|intcomma }}</p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_2.png' %}" alt="Количество работников">
                    </div>
                    <h3 class="stat-title-dark">Средняя численность работников</h3>
                    <p class="stat-value-dark">
                        {% if dataset_stats.avg_staff %}
                            {{ dataset_stats.avg_staff|floatformat:0|intcomma }}
                        {% else %}
                            —
                        {% endif %}
                    </p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_3.png' %}" alt="Количество вакансий">
                    </div>
                    <h3 class="stat-title-dark">Аккредитованные компании</h3>
                    <p class="stat-value-dark">
                        {{ dataset_stats.accredited|default:0|intcomma }}
                    </p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_4.png' %}" alt="Суммарный доход">
                    </div>
                    <h3 class="stat-title-dark">Суммарный доход</h3>
                    <p class="stat-value-large">
                        {% if dataset_stats.total_revenue %}
                            {{ dataset_stats.total_revenue|intcomma }} ₽
                        {% else %}
                            —
                        {% endif %}
                    </p>
                </article>
            </section>

            <section class="data-section">
                <form id="report-form" method="post" action="{% url 'report' %}">
                    {% csrf_token %}
                    <div class="data-header">
                        <div class="selected-count">
                            <input type="checkbox" class="checkbox-main" id="select-all">
                            <span id="selected-count">0 компаний выбрано</span>
                        </div>
                        <div class="data-header-buttons">
                            {% if is_director %}
                            <button type="button" class="btn-secondary" id="accreditation-button" data-action="{% url 'accreditation_sync' %}" disabled>Обновить аккредитацию</button>
                            <button type="button" class="btn-secondary" id="send-report-button" data-has-recipients="{% if report_recipients %}true{% else %}false{% endif %}" {% if not report_recipients %}disabled{% endif %}>Отправить отчёт</button>
                            <button type="submit" class="btn-primary" id="report-button" disabled>Сформировать отчёт</button>
                            {% if not report_recipients %}
                            <p class="selection-hint">Нет сотрудников для отправки отчёта — добавьте их в панели администратора.</p>
                            {% endif %}
                            {% else %}
                            <p class="selection-note">Управление отчётами доступно только директору.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="filters-and-tools">
                        <div class="active-filters">
                            <span class="active-filters-title">{{ selection_stats.count|default:0|intcomma }} компаний соответствует фильтрам</span>
                            <div class="chips" id="active-filters">
                                {% if active_filters %}
                                    {% for item in active_filters %}
                                    <span class="chip">{{ item }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="chip chip-muted">Фильтры не заданы</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="data-tools">
                            <input type="search" id="live-search" placeholder="Живой поиск по текущей выборке">
                            <p class="hint">Клик по заголовку — сортировка · Esc — очистить поиск</p>
                        </div>
                    </div>

                    <div class="data-table">
                        <table id="companies-table">
                            <thead>
                                <tr>
                                    <th class="table-cell-checkbox"></th>
                                    <th data-sort="text">Компания</th>
                                    <th data-sort="text">ОКВЭД</th>
                                    <th data-sort="number">Выручка</th>
                                    <th data-sort="number">Налоги</th>
                                    <th data-sort="number">кол-во<br>сотр.</th>
                                    <th data-sort="text">Аккредитация</th>
                                    <th data-sort="text">УСН</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr class="table-row">
                                    <td class="table-cell table-cell-checkbox">
                                        <input type="checkbox" class="row-checkbox" name="company_inn" value="{{ company.inn }}" aria-label="Выбрать {{ company.short_name|default:company.full_name }}">
                                    </td>
                                    <td class="table-cell">
                                        <h4 class="company-name" 
                                            data-company-info='{"full_name": "{{ company.full_name|escapejs }}", "inn": "{{ company.inn }}", "okved": "{{ company.okved|default:"—"|escapejs }}", "revenue": "{{ company.revenue|default:"—"|intcomma }}", "expenses": "{{ company.expenses|default:"—"|intcomma }}", "taxes": "{{ company.taxes|default:"—"|intcomma }}", "tax_year": "{{ company.tax_year|default:"—" }}", "staff": "{{ company.staff|default:"—" }}", "staff_year": "{{ company.staff_year|default:"—" }}", "uses_usn": "{{ company.uses_usn|yesno:"Да,Нет,—" }}", "ceo": "{{ company.ceo|default:"—"|escapejs }}", "registered_at": "{{ company.registered_at|default:"—" }}", "msme_at": "{{ company.msme_at|default:"—" }}", "financial_result": "{{ company.financial_result|default:"—"|intcomma }}", "accreditation_status": "{% if company.accreditation %}{{ company.accreditation.status|default:"—"|escapejs }}{% else %}—{% endif %}", "accreditation_decision": "{% if company.accreditation %}{{ company.accreditation.decision_number|default:"—"|escapejs }}{% else %}—{% endif %}", "accreditation_date": "{% if company.accreditation and company.accreditation.decision_date %}{{ company.accreditation.decision_date|date:"d.m.Y" }}{% else %}—{% endif %}"}'>
                                            {{ company.short_name|default:company.full_name }}
                                        </h4>
                                        <p class="company-details">{{ company.full_name }}<br>ИНН: {{ company.inn }}</p>
                                    </td>
                                    <td class="table-cell">
                                        <p class="okved-text">{{ company.okved|default:"—" }}</p>
                                    </td>
                                    <td class="table-cell" data-value="{{ company.revenue|default_if_none:0 }}">
                                        {% if company.revenue %}
                                            {{ company.revenue|intcomma }} ₽
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="table-cell" data-value="{{ company.taxes|default_if_none:0 }}">
                                        {% if company.taxes %}
                                            {{ company.taxes|intcomma }} ₽
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="table-cell" data-value="{{ company.staff|default_if_none:0 }}">
                                        {% if company.staff %}
                                            {{ company.staff }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="table-cell">
                                        <div class="accreditation-cell">
                                            {% if company.accreditation %}
                                                {% with company.accreditation.status|default_if_none:""|lower as accreditation_status %}
                                                    {% if "действ" in accreditation_status %}
                                                        <span class="status-badge">Действует</span>
                                                    {% else %}
                                                        <span class="status-badge status-badge-danger">{{ company.accreditation.status }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                                <p class="update-time">Обновлено:<br>{{ company.accreditation.checked_at|date:"d.m.Y H:i" }}</p>
                                            {% else %}
                                                <span class="status-badge status-badge-muted">—</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="table-cell">
                                        {% if company.uses_usn is True %}
                                            <span class="status-badge-yes">Да</span>
                                        {% elif company.uses_usn is False %}
                                            <span class="status-badge status-badge-danger">Нет</span>
                                        {% else %}
                                            <span class="status-badge status-badge-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <p>По заданным условиям ничего не найдено. Попробуйте смягчить фильтры.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if page_obj.has_other_pages %}
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" class="pagination-btn" title="Первая страница">«</a>
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="pagination-btn" title="Предыдущая страница">‹</a>
                        {% else %}
                            <span class="pagination-btn disabled">«</span>
                            <span class="pagination-btn disabled">‹</span>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="pagination-btn active">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="pagination-btn">{{ num }}</a>
                            {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="pagination-btn">{{ num }}</a>
                            {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="pagination-btn" title="Следующая страница">›</a>
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" class="pagination-btn" title="Последняя страница">»</a>
                        {% else %}
                            <span class="pagination-btn disabled">›</span>
                            <span class="pagination-btn disabled">»</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </form>
            </section>
        </main>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <img src="{% static 'dashboard_app/img/copyright.png' %}" alt="Метрика" class="footer-icon">
                <span>2025 Метрика, официальный сайт</span>
            </div>
            <div class="footer-center">
                <img src="{% static 'dashboard_app/img/footer_icon.png' %}" alt="Геолокация" class="footer-icon">
                <span>Г. Краснодар</span>
            </div>
            <div class="footer-right">
                <span>admin@metrika.com</span>
            </div>
        </div>
    </footer>

    {% if is_director %}
    <div class="modal" id="send-report-modal" aria-hidden="true">
        <div class="modal-backdrop" data-modal-close="true"></div>
        <div class="modal-panel">
            <button type="button" class="modal-close" data-modal-close="true" aria-label="Закрыть">×</button>
            <h3>Отправить Excel-отчёт сотруднику</h3>
            <p class="modal-text">Система отправит выбранному сотруднику всплывающее уведомление с возможностью скачать XLSX-файл.</p>
            <form id="send-report-form" method="post" action="{% url 'report_send' %}">
                {% csrf_token %}
                <label class="form-control">
                    <span>Получатель</span>
                    <select name="recipient_id" required {% if not report_recipients %}disabled{% endif %}>
                        {% for recipient in report_recipients %}
                        <option value="{{ recipient.id }}">{{ recipient.get_full_name|default:recipient.username }}</option>
                        {% endfor %}
                    </select>
                </label>
                <div class="modal-summary" id="send-report-summary">
                    Отметьте компании в таблице, чтобы прикрепить их к отчёту.
                </div>
                <div id="send-report-hidden-inputs"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" data-modal-close="true">Отмена</button>
                    <button type="submit" class="btn btn-primary" {% if not report_recipients %}disabled{% endif %}>Отправить</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if notifications_payload %}
        {{ notifications_payload|json_script:"notifications-data" }}
    {% endif %}
</body>
</html>

