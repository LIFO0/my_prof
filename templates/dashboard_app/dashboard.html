{% load static %}
{% load humanize %}
{% load tz %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{% static 'dashboard_app/img/logo.png' %}">
    <title>–ú–µ—Ç—Ä–∏–∫–∞ ‚Äî –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="{% static 'dashboard_app/styles.css' %}">
    <link rel="stylesheet" href="{% static 'dashboard_app/mail.css' %}">
    <script defer src="{% static 'dashboard_app/dashboard.js' %}"></script>
</head>
<body>
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message message-{{ message.tags|default:'info' }}">
            <span class="message-text">{{ message }}</span>
            <button class="message-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <header class="top-header">
        <a href="{% url 'dashboard' %}" class="top-header-brand">
            <img src="{% static 'dashboard_app/img/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø –ú–µ—Ç—Ä–∏–∫–∞" class="brand-logo">
            <div class="brand-text">
                <span class="brand-name">–ú–µ—Ç—Ä–∏–∫–∞</span>
                <span class="brand-tagline">–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</span>
            </div>
        </a>
        <div class="top-header-search">
            <div class="search-container">
                <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" fill="#9a9a9a"/>
                </svg>
                <input type="search" id="global-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º, –ò–ù–ù, –û–ö–í–≠–î..." value="{{ filters.search|default_if_none:'' }}">
            </div>
        </div>
        <div class="top-header-account">
            <a href="{% url 'mail_inbox' %}" class="mail-link">
                üìß –ü–æ—á—Ç–∞
                {% if unread_emails_count|default:0 > 0 %}
                <span class="mail-link-badge">{{ unread_emails_count }}</span>
                {% endif %}
            </a>
            <img src="{% static 'dashboard_app/img/account.png' %}" alt="–£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å" class="account-avatar">
            <div class="account-details">
                <span class="account-name">{{ user.get_full_name|default:user.username }}</span>
                <span class="account-role">({{ is_director|yesno:"–¥–∏—Ä–µ–∫—Ç–æ—Ä,—Å–æ—Ç—Ä—É–¥–Ω–∏–∫" }})</span>
            </div>
            <a class="logout-button" href="{% url 'logout' %}">–í—ã—Ö–æ–¥</a>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <h1 class="sidebar-title">–§–∏–ª—å—Ç—Ä—ã</h1>
            <p class="sidebar-subtitle">–ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Ç–æ—á–Ω—É—é –≤—ã–±–æ—Ä–∫—É –¥–∞–Ω–Ω—ã—Ö.</p>
            <form id="filters-form" method="get">
                <div class="filter-group">
                    <label class="filter-label" for="filter-search">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –§–ò–û</label>
                    <input id="filter-search" type="text" name="search" class="filter-input" value="{{ filters.search|default_if_none:'' }}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–ò–¢–†–ò–ö–°">
                </div>

                <div class="filter-group">
                    <label class="filter-label">–û—Å–Ω–æ–≤–Ω–æ–π –û–ö–í–≠–î</label>
                    <select class="filter-select" name="okved">
                        <option value="">–í—Å–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è</option>
                        {% for okved in filter_options.okveds %}
                        <option value="{{ okved }}" {% if filters.okved == okved %}selected{% endif %}>{{ okved }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ü—Ä–∏–º–µ–Ω—è–µ—Ç –£–°–ù</label>
                    <select class="filter-select" name="uses_usn">
                        <option value="">–ù–µ –≤–∞–∂–Ω–æ</option>
                        <option value="yes" {% if filters.uses_usn is True %}selected{% endif %}>–î–∞</option>
                        <option value="no" {% if filters.uses_usn is False %}selected{% endif %}>–ù–µ—Ç</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è</label>
                    <select class="filter-select" name="is_accredited">
                        <option value="">–ù–µ –≤–∞–∂–Ω–æ</option>
                        <option value="yes" {% if filters.is_accredited is True %}selected{% endif %}>–ê–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∞</option>
                        <option value="no" {% if filters.is_accredited is False %}selected{% endif %}>–ù–µ –∞–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∞</option>
                    </select>
                </div>

                <div class="filter-row">
                    <div class="filter-group-half">
                        <label class="filter-label">–ú–∏–Ω. –≤—ã—Ä—É—á–∫–∞ (‚ÇΩ)</label>
                        <input type="number" class="filter-input-small" name="min_revenue" min="{{ bounds.revenue.0 }}" max="{{ bounds.revenue.1 }}" step="100000" value="{{ filters.min_revenue|default_if_none:'' }}" placeholder="{{ bounds.revenue.0|default:0 }}">
                    </div>
                    <div class="filter-group-half">
                        <label class="filter-label">–ú–∞–∫—Å. –≤—ã—Ä—É—á–∫–∞ (‚ÇΩ)</label>
                        <input type="number" class="filter-input-small" name="max_revenue" min="{{ bounds.revenue.0 }}" max="{{ bounds.revenue.1 }}" step="100000" value="{{ filters.max_revenue|default_if_none:'' }}" placeholder="{{ bounds.revenue.1|default:0 }}">
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ú–∏–Ω. –Ω–∞–ª–æ–≥–∏ (‚ÇΩ)</label>
                    <input type="number" class="filter-input" name="min_taxes" min="{{ bounds.taxes.0 }}" max="{{ bounds.taxes.1 }}" step="50000" value="{{ filters.min_taxes|default_if_none:'' }}">
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ú–∏–Ω. —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</label>
                    <input type="number" class="filter-input" name="min_staff" min="{{ bounds.staff.0 }}" max="{{ bounds.staff.1 }}" value="{{ filters.min_staff|default_if_none:'' }}">
                </div>

                <div class="filter-row">
                    <div class="filter-group-half">
                        <label class="filter-label filter-label-wrap">–ì–æ–¥ —É–ø–ª–∞—Ç—ã –Ω–∞–ª–æ–≥–æ–≤</label>
                        <select class="filter-select-small" name="tax_year">
                            <option value="">–õ—é–±–æ–π</option>
                            {% for year in filter_options.tax_years %}
                            <option value="{{ year }}" {% if filters.tax_year == year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group-half">
                        <label class="filter-label filter-label-wrap">–ì–æ–¥ —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏</label>
                        <select class="filter-select-small" name="staff_year">
                            <option value="">–õ—é–±–æ–π</option>
                            {% for year in filter_options.staff_years %}
                            <option value="{{ year }}" {% if filters.staff_year == year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <a class="btn-reset" href="{% url 'dashboard' %}">–°–±—Ä–æ—Å–∏—Ç—å</a>
                </div>
            </form>

            <p class="quick-scenarios-title">–ë–´–°–¢–†–´–ï –°–¶–ï–ù–ê–†–ò–ò</p>
            <div class="quick-scenarios">
                <button type="button" class="filter-select" data-filter-preset="top-revenue">–õ–∏–¥–µ—Ä—ã –ø–æ –≤—ã—Ä—É—á–∫–µ</button>
                <button type="button" class="filter-select" data-filter-preset="hi-staff">100+ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</button>
                <button type="button" class="filter-select" data-filter-preset="usn-only">–¢–æ–ª—å–∫–æ –£–°–ù</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <h1 class="page-title">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
                <p class="page-subtitle">–£–¥–æ–±—Å—Ç–≤–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</p>
            </header>

            <section class="stats-grid">
                <article class="stat-card stat-card-primary">
                    <div class="stat-icon">
                        <img src="{% static 'dashboard_app/img/icon_1.png' %}" alt="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π">
                    </div>
                    <h3 class="stat-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–æ–º–ø–∞–Ω–∏–π</h3>
                    <p class="stat-value">{{ dataset_stats.count|default:0|intcomma }}</p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_2.png' %}" alt="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤">
                    </div>
                    <h3 class="stat-title-dark">–°—Ä–µ–¥–Ω—è—è —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h3>
                    <p class="stat-value-dark">
                        {% if dataset_stats.avg_staff %}
                            {{ dataset_stats.avg_staff|floatformat:0|intcomma }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_3.png' %}" alt="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–∫–∞–Ω—Å–∏–π">
                    </div>
                    <h3 class="stat-title-dark">–ê–∫–∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
                    <p class="stat-value-dark">
                        {{ dataset_stats.accredited|default:0|intcomma }}
                    </p>
                </article>

                <article class="stat-card stat-card-secondary">
                    <div class="stat-icon-dark">
                        <img src="{% static 'dashboard_app/img/icon_4.png' %}" alt="–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ—Ö–æ–¥">
                    </div>
                    <h3 class="stat-title-dark">–°—É–º–º–∞—Ä–Ω—ã–π –¥–æ—Ö–æ–¥</h3>
                    <p class="stat-value-large">
                        {% if dataset_stats.total_revenue %}
                            {{ dataset_stats.total_revenue|intcomma }} ‚ÇΩ
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </p>
                </article>
            </section>

            <section class="data-section">
                <form id="report-form" method="post" action="{% url 'report' %}">
                    {% csrf_token %}
                    <div id="all-companies-data" data-all-inns="{{ all_filtered_inns|join:',' }}" style="display: none;"></div>
                    <div class="data-header">
                        <div class="selected-count">
                            <input type="checkbox" class="checkbox-main" id="select-all">
                            <span id="selected-count">0 –∫–æ–º–ø–∞–Ω–∏–π –≤—ã–±—Ä–∞–Ω–æ</span>
                            <button type="button" class="btn-select-all" id="select-all-button">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</button>
                        </div>
                        <div class="data-header-buttons">
                            {% if is_director %}
                            <button type="button" class="btn-secondary" id="accreditation-button" data-action="{% url 'accreditation_sync' %}" disabled>–û–±–Ω–æ–≤–∏—Ç—å –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—é</button>
                            <button type="button" class="btn-secondary" id="send-report-button" data-has-recipients="{% if report_recipients %}true{% else %}false{% endif %}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
                            <button type="submit" class="btn-primary" id="report-button" disabled>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
                            {% if not report_recipients %}
                            <p class="selection-hint">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
                            {% endif %}
                            {% else %}
                            <p class="selection-note">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞–º–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É.</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="filters-and-tools">
                        <div class="active-filters">
                            <span class="active-filters-title">{{ selection_stats.count|default:0|intcomma }} –∫–æ–º–ø–∞–Ω–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞–º</span>
                            <div class="chips" id="active-filters">
                                {% if active_filters %}
                                    {% for item in active_filters %}
                                    <span class="chip">{{ item }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="chip chip-muted">–§–∏–ª—å—Ç—Ä—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="data-tools">
                            <input type="search" id="live-search" placeholder="–ñ–∏–≤–æ–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–µ">
                            <p class="hint">–ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É ‚Äî —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ¬∑ Esc ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</p>
                        </div>
                    </div>

                    <div class="data-table">
                        <table id="companies-table">
                            <thead>
                                <tr>
                                    <th class="table-cell-checkbox"></th>
                                    <th data-sort="text">–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th data-sort="text">–û–ö–í–≠–î</th>
                                    <th data-sort="number">–í—ã—Ä—É—á–∫–∞</th>
                                    <th data-sort="number">–ù–∞–ª–æ–≥–∏</th>
                                    <th data-sort="number">–∫–æ–ª-–≤–æ<br>—Å–æ—Ç—Ä.</th>
                                    <th data-sort="text">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è</th>
                                    <th data-sort="text">–£–°–ù</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in companies %}
                                <tr class="table-row">
                                    <td class="table-cell table-cell-checkbox">
                                        <input type="checkbox" class="row-checkbox" name="company_inn" value="{{ company.inn }}" aria-label="–í—ã–±—Ä–∞—Ç—å {{ company.short_name|default:company.full_name }}">
                                    </td>
                                    <td class="table-cell">
                                        <h4 class="company-name" 
                                            data-company-info='{"full_name": "{{ company.full_name|escapejs }}", "inn": "{{ company.inn }}", "okved": "{{ company.okved|default:"‚Äî"|escapejs }}", "revenue": "{{ company.revenue|default:"‚Äî"|intcomma }}", "expenses": "{{ company.expenses|default:"‚Äî"|intcomma }}", "taxes": "{{ company.taxes|default:"‚Äî"|intcomma }}", "tax_year": "{{ company.tax_year|default:"‚Äî" }}", "staff": "{{ company.staff|default:"‚Äî" }}", "staff_year": "{{ company.staff_year|default:"‚Äî" }}", "uses_usn": "{{ company.uses_usn|yesno:"–î–∞,–ù–µ—Ç,‚Äî" }}", "ceo": "{{ company.ceo|default:"‚Äî"|escapejs }}", "registered_at": "{{ company.registered_at|default:"‚Äî" }}", "msme_at": "{{ company.msme_at|default:"‚Äî" }}", "financial_result": "{{ company.financial_result|default:"‚Äî"|intcomma }}", "accreditation_status": "{% if company.accreditation %}{{ company.accreditation.status|default:"‚Äî"|escapejs }}{% else %}‚Äî{% endif %}", "accreditation_decision": "{% if company.accreditation %}{{ company.accreditation.decision_number|default:"‚Äî"|escapejs }}{% else %}‚Äî{% endif %}", "accreditation_date": "{% if company.accreditation and company.accreditation.decision_date %}{{ company.accreditation.decision_date|date:"d.m.Y" }}{% else %}‚Äî{% endif %}"}'>
                                            {{ company.short_name|default:company.full_name }}
                                        </h4>
                                        <p class="company-details">{{ company.full_name }}<br>–ò–ù–ù: {{ company.inn }}</p>
                                    </td>
                                    <td class="table-cell">
                                        <p class="okved-text">{{ company.okved|default:"‚Äî" }}</p>
                                    </td>
                                    <td class="table-cell" data-value="{{ company.revenue|default_if_none:0 }}">
                                        {% if company.revenue %}
                                            {{ company.revenue|intcomma }} ‚ÇΩ
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td class="table-cell" data-value="{{ company.taxes|default_if_none:0 }}">
                                        {% if company.taxes %}
                                            {{ company.taxes|intcomma }} ‚ÇΩ
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td class="table-cell" data-value="{{ company.staff|default_if_none:0 }}">
                                        {% if company.staff %}
                                            {{ company.staff }}
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </td>
                                    <td class="table-cell">
                                        <div class="accreditation-cell">
                                            {% if company.accreditation %}
                                                {% with company.accreditation.status|default_if_none:""|lower as accreditation_status %}
                                                    {% if "–¥–µ–π—Å—Ç–≤" in accreditation_status %}
                                                        <span class="status-badge">–î–µ–π—Å—Ç–≤—É–µ—Ç</span>
                                                    {% else %}
                                                        <span class="status-badge status-badge-danger">{{ company.accreditation.status }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                                <p class="update-time">–û–±–Ω–æ–≤–ª–µ–Ω–æ:<br>{{ company.accreditation.checked_at|localtime|date:"d.m.Y H:i" }}</p>
                                            {% else %}
                                                <span class="status-badge status-badge-muted">‚Äî</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="table-cell">
                                        {% if company.uses_usn is True %}
                                            <span class="status-badge-yes">–î–∞</span>
                                        {% elif company.uses_usn is False %}
                                            <span class="status-badge status-badge-danger">–ù–µ—Ç</span>
                                        {% else %}
                                            <span class="status-badge status-badge-muted">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <p>–ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–º—è–≥—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if page_obj.has_other_pages %}
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" class="pagination-btn" title="–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬´</a>
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="pagination-btn" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">‚Äπ</a>
                        {% else %}
                            <span class="pagination-btn disabled">¬´</span>
                            <span class="pagination-btn disabled">‚Äπ</span>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="pagination-btn active">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="pagination-btn">{{ num }}</a>
                            {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="pagination-btn">{{ num }}</a>
                            {% elif num == page_obj.number|add:'-4' or num == page_obj.number|add:'4' %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="pagination-btn" title="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">‚Ä∫</a>
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" class="pagination-btn" title="–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">¬ª</a>
                        {% else %}
                            <span class="pagination-btn disabled">‚Ä∫</span>
                            <span class="pagination-btn disabled">¬ª</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </form>
            </section>
        </main>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <img src="{% static 'dashboard_app/img/copyright.png' %}" alt="–ú–µ—Ç—Ä–∏–∫–∞" class="footer-icon">
                <span>2025 –ú–µ—Ç—Ä–∏–∫–∞, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç</span>
            </div>
            <div class="footer-center">
                <img src="{% static 'dashboard_app/img/footer_icon.png' %}" alt="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è" class="footer-icon">
                <span>–≥. –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥</span>
            </div>
            <div class="footer-right">
                <span>admin@metrika.com</span>
            </div>
        </div>
    </footer>

    {% if is_director %}
    <div class="modal" id="send-report-modal" aria-hidden="true">
        <div class="modal-backdrop" data-modal-close="true"></div>
        <div class="modal-panel">
            <button type="button" class="modal-close" data-modal-close="true" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å Excel-–æ—Ç—á—ë—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</h3>
            <p class="modal-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏: –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –ø–æ email –∞–¥—Ä–µ—Å—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</p>
            <form id="send-report-form" method="post" action="{% url 'report_send' %}">
                {% csrf_token %}
                <label class="form-control">
                    <span>–°–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                    <select name="send_method" id="send-method-select" required>
                        <option value="user">–í—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞</option>
                        <option value="email">–£–∫–∞–∑–∞—Ç—å email –∞–¥—Ä–µ—Å</option>
                    </select>
                </label>
                <label class="form-control" id="recipient-select-label">
                    <span>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</span>
                    <select name="recipient_id" id="recipient-select" {% if not report_recipients %}disabled{% endif %}>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>
                        {% for recipient in report_recipients %}
                        <option value="{{ recipient.id }}">{{ recipient.get_full_name|default:recipient.username }} ({{ recipient.profile.get_internal_email }})</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="form-control" id="email-select-label" style="display: none;">
                    <span>Email –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</span>
                    <select name="recipient_email" id="recipient-email-select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ email –∞–¥—Ä–µ—Å</option>
                        {% for recipient in report_recipients %}
                        <option value="{{ recipient.profile.get_internal_email }}">{{ recipient.get_full_name|default:recipient.username }} ‚Äî {{ recipient.profile.get_internal_email }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="form-control" style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 12px;">
                    <input type="checkbox" name="use_email" value="true" id="use-email-checkbox" checked style="width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <span style="font-weight: 600; display: block; margin-bottom: 4px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ—á—Ç–µ</span>
                        <span style="font-size: 0.875rem; color: #64748b;">–ü–∏—Å—å–º–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π email –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</span>
                    </div>
                </label>
                <div class="modal-summary" id="send-report-summary">
                    –û—Ç–º–µ—Ç—å—Ç–µ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ, —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏—Ö –∫ –æ—Ç—á—ë—Ç—É.
                </div>
                <div id="send-report-hidden-inputs"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" data-modal-close="true">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if notifications_payload %}
        {{ notifications_payload|json_script:"notifications-data" }}
    {% endif %}
</body>
</html>

