{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{% static 'dashboard_app/img/logo.png' %}">
    <title>–í—Ö–æ–¥—è—â–∏–µ ‚Äî –ú–µ—Ç—Ä–∏–∫–∞</title>
    <link rel="stylesheet" href="{% static 'dashboard_app/styles.css' %}">
    <link rel="stylesheet" href="{% static 'dashboard_app/mail.css' %}">
</head>
<body>
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="message message-{{ message.tags|default:'info' }}">
            <span class="message-text">{{ message }}</span>
            <button class="message-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <header class="top-header">
        <a href="{% url 'dashboard' %}" class="top-header-brand">
            <img src="{% static 'dashboard_app/img/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø –ú–µ—Ç—Ä–∏–∫–∞" class="brand-logo">
            <div class="brand-text">
                <span class="brand-name">–ú–µ—Ç—Ä–∏–∫–∞</span>
                <span class="brand-tagline">–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</span>
            </div>
        </a>
        <div class="top-header-account">
            <a href="{% url 'dashboard' %}" class="mail-back-to-dashboard">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="{% url 'mail_inbox' %}" class="mail-link active">
                üìß –ü–æ—á—Ç–∞
                {% if unread_emails_count|default:0 > 0 %}
                <span class="mail-link-badge">{{ unread_emails_count }}</span>
                {% endif %}
            </a>
            <img src="{% static 'dashboard_app/img/account.png' %}" alt="–£—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å" class="account-avatar">
            <div class="account-details">
                <span class="account-name">{{ user.get_full_name|default:user.username }}</span>
                <span class="mail-account-email">{{ user_email }}</span>
            </div>
            <a class="logout-button" href="{% url 'logout' %}">–í—ã—Ö–æ–¥</a>
        </div>
    </header>

    <div class="mail-container">
        <div class="mail-header">
            <h1 class="mail-title">–í—Ö–æ–¥—è—â–∏–µ</h1>
            <div class="mail-header-actions">
                <a href="{% url 'mail_sent' %}" class="mail-link">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ</a>
                <span class="mail-stats">–í—Å–µ–≥–æ: {{ total_count }}</span>
                {% if unread_count > 0 %}
                <span class="mail-badge">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö: {{ unread_count }}</span>
                {% endif %}
            </div>
        </div>

        <div class="mail-filters">
            <a href="?filter=all" class="mail-filter-btn {% if filter_read == 'all' %}active{% endif %}">–í—Å–µ</a>
            <a href="?filter=unread" class="mail-filter-btn {% if filter_read == 'unread' %}active{% endif %}">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</a>
            <a href="?filter=read" class="mail-filter-btn {% if filter_read == 'read' %}active{% endif %}">–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</a>
        </div>

        {% if page_obj %}
        <div class="mail-list">
            {% for email in page_obj %}
            <a href="{% url 'mail_view' email.id %}" class="mail-item {% if not email.is_read %}unread{% endif %}">
                <div class="mail-item-content">
                    <div class="mail-item-main">
                        <div class="mail-item-header">
                            <span class="mail-sender-name">{{ email.sender.get_full_name|default:email.sender.username }}</span>
                            <span class="mail-sender-email">{{ email.payload.sender_email|default:'' }}</span>
                            {% if not email.is_read %}
                            <span class="mail-new-badge">–ù–æ–≤–æ–µ</span>
                            {% endif %}
                        </div>
                        <div class="mail-item-subject">{{ email.subject|default:email.title }}</div>
                        <div class="mail-item-preview">{{ email.message|truncatewords:20 }}</div>
                    </div>
                    <div class="mail-item-date">{{ email.created_at|date:"d.m.Y H:i" }}</div>
                </div>
            </a>
            {% endfor %}
        </div>

        {% if page_obj.has_other_pages %}
        <div class="mail-pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if filter_read != 'all' %}&filter={{ filter_read }}{% endif %}" class="mail-pagination-link">‚Üê –ù–∞–∑–∞–¥</a>
            {% endif %}
            <span class="mail-pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if filter_read != 'all' %}&filter={{ filter_read }}{% endif %}" class="mail-pagination-link">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
            {% endif %}
        </div>
        {% endif %}
        {% else %}
        <div class="mail-empty">
            <p class="mail-empty-title">–ù–µ—Ç –ø–∏—Å–µ–º</p>
            <p class="mail-empty-text">–í—Ö–æ–¥—è—â–∏–µ –ø–∏—Å—å–º–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
        </div>
        {% endif %}
    </div>

    <script>
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        document.querySelectorAll('.message-close').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.message').remove();
            });
        });
    </script>
</body>
</html>
